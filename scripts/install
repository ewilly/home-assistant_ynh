#!/bin/bash

set -eu
source _common.sh
source /usr/share/yunohost/helpers

# manage script failure
ynh_abort_if_errors

# retrieve arguments
domain=$YNH_APP_ARG_DOMAIN
path_url=$YNH_APP_ARG_PATH
app=$YNH_APP_INSTANCE_NAME

# definie useful vars
final_path="/srv/$app"
data_path="/home/$app/.$app"

# check domain/path availability
path_url=$(ynh_normalize_url_path $path_url)
ynh_webpath_available $domain $path_url
ynh_webpath_register $app $domain $path_url

# add required packages
ynh_install_app_dependencies "$PKG_DEPENDENCIES"

# save app settings
ynh_app_setting_set $app domain $domain
ynh_app_setting_set $app path $path_url

# find a free port & open it
## for Home Assistant 
port=$(ynh_find_port 8123)
ynh_app_setting_set $app port $port
yunohost firewall allow TCP $port > /dev/null 2>&1
## for Home Assistant configurator
port_configurator=$(ynh_find_port 3218)
ynh_app_setting_set $app port_configurator $port_configurator
yunohost firewall allow TCP $port_configurator > /dev/null 2>&1

# create a dedicated system user
useradd -rm $app -G dialout,gpio

# create a directory for the installation of Home Assistant
myynh_create_dir $final_path
chown $app:$app $final_path

# create a directory for the datas of Home Assistant
myynh_create_dir $data_path
chown $app:$app $data_path

# installation
## for Home Assistant in a virtual environment
exec_as "$app" -H -s /bin/bash -c " \
	# create the virtual environment
	python3 -m venv $final_path \
	# activate the virtual environment
	&& source $final_path/bin/activate \
	# install a required python package
	&& python3 -m pip install wheel \
	# install Home Assistant
	&& pip3 install $app==$UPSTREAM_VERSION
	# install Home Assistant configurator
	&& wget https://raw.githubusercontent.com/danielperna84/hass-configurator/master/configurator.py
	&& chmod 755 configurator.py
	# quit the virtual environment
	&& deactivate \
	"

# setup up autostart using systemd
## for Home Assistant
systemctl enable $app@$app
## for Home Assistant configurator
cp ../conf/$app-configurator.service /etc/systemd/system/$app-configurator@$app.service

# add service in admin panel
## for Home Assistant
yunohost service add $app@$app
## for Home Assistant configurator
yunohost service add $app-configurator@$app

# enable & restart service
systemctl --system daemon-reload
## for Home Assistant
systemctl enable $app@$app
systemctl restart $app@$app
## for Home Assistant configurator
systemctl enable $app-configurator@$app
systemctl restart $app-configurator@$app

# create a dedicated nginx config
## for Home Assistant
ynh_add_nginx_config
## for Home Assistant configurator

# reload nginx
systemctl reload nginx

